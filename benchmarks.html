<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Benchmarking
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Port of Google's farm hash algorithm"/>
    <meta name="author" content="Nick Babcock"/>
    <link rel="icon" href="/Farmhash.Sharp/favicon.ico">
    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/Farmhash.Sharp/content/style.css" />
    <script type="text/javascript" src="/Farmhash.Sharp/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/nickbabcock/Farmhash.Sharp">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/Farmhash.Sharp/index.html">Farmhash.Sharp</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Benchmarking" class="anchor" href="#Benchmarking">Benchmarking</a></h1>
<p>Using <a href="https://github.com/PerfDotNet/BenchmarkDotNet">BenchmarkDotNet</a>, the
FarmHash.Sharp benchmarking code pits several non-cryptographic hash functions
against each other in terms of throughput.</p>
<p>Benchmarking was done on the following machine:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="ini">BenchmarkDotNet=v0.9.1.0
OS=Microsoft Windows NT 6.2.9200.0
Processor=Intel(R) Core(TM) i7-6700K CPU @ 4.00GHz, ProcessorCount=8
Frequency=3914059 ticks, Resolution=255.4893 ns
HostCLR=MS.NET 4.0.30319.42000, Arch=64-bit RELEASE [RyuJIT]
</code></pre></td></tr></table>
<p>To run the benchmarks:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">build</span><span class="o">.</span><span class="i">cmd</span> <span class="i">Benchmark</span>
<span class="o">.</span><span class="o">/</span><span class="i">build</span><span class="o">.</span><span class="i">sh</span> <span class="i">Benchmark</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Median-Time-to-Hash" class="anchor" href="#Median-Time-to-Hash">Median Time to Hash</a></h2>
<p><img src="/Farmhash.Sharp/img/farmhash-benchmark1.png" alt="Farmhash-benchmark1" /></p>
<p>The graph depicts the median time in nanoseconds to hash data of a certain
size grouped by resulting hash size (eg. 32 or 64bit, which is not underlying
machine architecture). A logarithmic scale had to be applied because other
hash functions are so slow, they'd heavily skew the graph.</p>
<p>We can see for 64bit, that when hashing data that is 1000 bytes (~1KB), that
FarmHash is about 10x faster than the closest competitor.</p>
<p>For 32bit hash functions, the built in <code>GetHashCode</code> on strings has a tight
grip on smaller data, but falls off for larget data.</p>
<h2><a name="Relative-Throughput" class="anchor" href="#Relative-Throughput">Relative Throughput</a></h2>
<p><img src="/Farmhash.Sharp/img/farmhash-benchmark2.png" alt="Farmhash-benchmark2" /></p>
<p>The bar shows the relative throughput of each hash function relative to the
fastest hash function in that category. So the higher the bar chart, the
better.</p>
<p>Here we combine resulting 32 and 64 bit hash functions for an interesting
result. Across all data sizes, the FarmHash-64bit version is fastest, though
for short string lengths, <code>GetHashCode</code> gives FarmHash a run for its money.</p>
<h2><a name="C-vs-C" class="anchor" href="#C-vs-C">C# vs. C++</a></h2>
<p>A good question would be how much efficiency is lost because we're using
C# and not C++, as the original farmhash algorithm uses C++. You can find the
benchmark code <a href="https://github.com/nickbabcock/Farmhash.Sharp/tree/5ef3ffc22a1b70b7875dc0b5ae73be496a45fb28/src/Farmhash.Benchmarks">here</a>.
It uses two versions of the algorithm, one that uses hardware acceleration
(<a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a> instructions) and one that doesn't
(denoted by no-ha in the next graph).</p>
<p><img src="/Farmhash.Sharp/img/c-sharp-vs-cpp.png" alt="Farmhash-benchmark3" /></p>
<p>I'm pleased to report that for small payloads (&lt;= 25 bytes), Farmhash.Sharp
is around 75% as fast as the fastest configuration. It's only at larger payloads
do we see C++'s lead extend as hardware acceleration becomes more effective.</p>
<h2><a name="Conclusion" class="anchor" href="#Conclusion">Conclusion</a></h2>
<p>When deploying on a 64bit application, always choose the 64bit Farmhash
version. If, for whatever reason, Farmhash isn't for you, choose xxHash for
data of lengths less than 1000 bytes and HashFunction CityHash for lengths
greater than 1000.</p>
<p>And I'm just going to squirrel away the code used to generate the graph.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="R">library(ggplot2)
library(dplyr)

data &lt;- read.csv("farmhash-report.csv", sep=";") %&gt;%
  select(Type, Method, Size=PayloadLength, Median)

breaks &lt;- data %&gt;% select(Size) %&gt;% distinct() %&gt;% arrange(Size) %&gt;% t %&gt;% c

ggplot(data, aes(as.factor(Size), Median, group=Method, color=Method)) +
  labs(title='Median Time to Hash', x='Data size (bytes)',
       y='Time to hash (ns)') +
  geom_line(size=1.5) +
  scale_y_log10() +
  facet_grid(Type ~ .)

relative &lt;- data %&gt;%
  mutate(Name = paste(Method, Type, sep="-")) %&gt;%
  select(-Method, -Type) %&gt;%
  group_by(Size) %&gt;%
  arrange(Median) %&gt;%
  mutate(value = first(Median) / Median) %&gt;%
  top_n(5, wt = value)

ggplot(relative, aes(as.factor(Size), value)) +
  geom_bar(aes(fill=Name), stat='identity', position='dodge') +
  labs(title='Relative Throughput across Resulting Hash Size', 
       x='Data size (bytes)', y="Relative Throughput")
</code></pre></td></tr></table>
<p>And the code for the C# vs C++ graph:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="R">library(ggplot2)
library(dplyr)

benchmark &lt;- c("farmhash-ha","farmhash-ha","farmhash-ha","farmhash-ha","farmhash-ha","farmhash-ha",
               "farmhash","farmhash","farmhash","farmhash","farmhash","farmhash",
               "Farmhash.Sharp","Farmhash.Sharp","Farmhash.Sharp","Farmhash.Sharp","Farmhash.Sharp",
               "Farmhash.Sharp")

payload &lt;- c(4, 11, 25, 100, 1000, 10000, 4, 11, 25, 100, 1000, 10000,
             4, 11, 25, 100, 1000, 10000)

# Throughput is measured in how many GB/s can be hashed
throughput &lt;- c(1.03503, 2.50114, 5.68304, 5.82953, 13.0187, 23.7148, 1.3749, 3.04061, 6.6442,
                5.79228, 14.2568, 16.2982, 1.1241, 2.5563, 5.171, 2.80498, 5.86157, 6.528081)

data &lt;- data.frame(benchmark, payload, throughput)

relative &lt;- data %&gt;%
  group_by(payload) %&gt;%
  arrange(throughput) %&gt;%
  mutate(value = throughput / last(throughput))

ggplot(relative, aes(as.factor(payload), value)) +
  geom_bar(aes(fill=benchmark), stat='identity', position='dodge') +
  labs(title='Relative Throughput of Farmhash: C# vs C++',
       x='Data size (bytes)', y="Relative Throughput")
</code></pre></td></tr></table>


        </div>
        <div class="span3">
          <img src="/Farmhash.Sharp/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Farmhash.Sharp</li>
            <li><a href="/Farmhash.Sharp/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/Farmhash.Sharp">Get Library via NuGet</a></li>
            <li><a href="http://github.com/nickbabcock/Farmhash.Sharp">Source Code on GitHub</a></li>
            <li><a href="/Farmhash.Sharp/license.html">License</a></li>
            <li><a href="/Farmhash.Sharp/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/Farmhash.Sharp/tutorial.html">Sample tutorial</a></li>

            <li class="nav-header">Documentation</li>
              <li><a href="/Farmhash.Sharp/reference/index.html">API Reference</a></li>
              <li><a href="/Farmhash.Sharp/benchmarks.html">Benchmarks</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/nickbabcock/Farmhash.Sharp"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
